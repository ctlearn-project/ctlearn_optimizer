

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>ctlearn_optimizer.common &mdash; ctlearn_optimizer 1.0.0 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> ctlearn_optimizer
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usage.html">Basic usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../settings.html">Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api.html">Package Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contributing.html">Contributing to ctlearn_optimizer</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">ctlearn_optimizer</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>ctlearn_optimizer.common</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for ctlearn_optimizer.common</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">csv</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">multiprocessing</span>
<span class="kn">from</span> <span class="nn">timeit</span> <span class="k">import</span> <span class="n">default_timer</span> <span class="k">as</span> <span class="n">timer</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">sklearn.metrics</span>
<span class="kn">import</span> <span class="nn">yaml</span>
<span class="kn">from</span> <span class="nn">ctlearn.run_model</span> <span class="k">import</span> <span class="n">run_model</span>

<span class="c1"># set dummy authentication key for multiprocessing</span>
<span class="n">multiprocessing</span><span class="o">.</span><span class="n">current_process</span><span class="p">()</span><span class="o">.</span><span class="n">authkey</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;1234&#39;</span>


<div class="viewcode-block" id="set_value"><a class="viewcode-back" href="../../api.html#ctlearn_optimizer.common.set_value">[docs]</a><span class="k">def</span> <span class="nf">set_value</span><span class="p">(</span><span class="n">dictionary</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="o">*</span><span class="n">keys</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Modify the value the keys point to in a nested dictionary.</span>

<span class="sd">    The dictionary can be a nested dictionary containing lists, these lists can</span>
<span class="sd">    also contain nested dictionaries, and so on. The keys list can contain</span>
<span class="sd">    strings (which refer dictionary keys) and integers (which refer list</span>
<span class="sd">    indices). Dictionary cannot be empty.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        dictionary [dict]: dictionary that contais the key-value pair the user</span>
<span class="sd">            wishes to modify.</span>
<span class="sd">        value [int, float, string]: value to set.</span>
<span class="sd">        keys [list]: list of keys containing strings and integers.</span>

<span class="sd">    Returns:</span>
<span class="sd">        modified dictionary [dict].</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; dictionary = {&#39;a&#39;:[0,{&#39;b&#39;:1},0]}</span>
<span class="sd">        &gt;&gt;&gt; value = 2</span>
<span class="sd">        &gt;&gt;&gt; keys = [&#39;a&#39;, 1, &#39;b&#39;]</span>
<span class="sd">        &gt;&gt;&gt; set_value(dictionary, value, *keys) = {&#39;a&#39;:[0,{&#39;b&#39;:2},0]}</span>

<span class="sd">    Raises:</span>
<span class="sd">        TypeError: if type(dictionary) != dict.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dictionary</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;set_value expects dict as first argument&#39;</span><span class="p">)</span>

    <span class="n">_keys</span> <span class="o">=</span> <span class="n">keys</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">_element</span> <span class="o">=</span> <span class="n">dictionary</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">_keys</span><span class="p">:</span>
        <span class="n">_element</span> <span class="o">=</span> <span class="n">_element</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
    <span class="n">_element</span><span class="p">[</span><span class="n">keys</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">value</span>

    <span class="k">return</span> <span class="n">dictionary</span></div>


<div class="viewcode-block" id="create_nested_item"><a class="viewcode-back" href="../../api.html#ctlearn_optimizer.common.create_nested_item">[docs]</a><span class="k">def</span> <span class="nf">create_nested_item</span><span class="p">(</span><span class="n">dictionary</span><span class="p">,</span> <span class="o">*</span><span class="n">keys</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create an empty item with specific keys and positions in a dictionary.</span>

<span class="sd">    The dictionary can be a nested dictionary containing lists, these lists can</span>
<span class="sd">    also contain nested dictionaries, and so on. The keys list can contain</span>
<span class="sd">    string (which refer dictionary keys) and integers (which refer list</span>
<span class="sd">    indices). The dictionary may or may be not empty.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        dictionary [dict]: dictionary to modify.</span>
<span class="sd">        keys [list]: list of keys containing strings and integers.</span>

<span class="sd">    Returns:</span>
<span class="sd">        modified dictionary [dict].</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; dictionary = {}</span>
<span class="sd">        &gt;&gt;&gt; keys = [&#39;a&#39;, &#39;b&#39;, 1, &#39;c&#39;, 2 , &#39;d&#39;]</span>
<span class="sd">        &gt;&gt;&gt; create_nested_item(dictionary, *keys) =</span>
<span class="sd">        &gt;&gt;&gt; {&#39;a&#39;: {&#39;b&#39;: [0, {&#39;c&#39;: [0, 0, {&#39;d&#39;: {}}]}]}}</span>

<span class="sd">    Raises:</span>
<span class="sd">        TypeError: if type(dictionary) != dict.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dictionary</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;create_nested_item expects dict as first argument&#39;</span><span class="p">)</span>

    <span class="n">_keys</span> <span class="o">=</span> <span class="n">keys</span>
    <span class="n">_element</span> <span class="o">=</span> <span class="n">dictionary</span>

    <span class="c1"># iterate over the list of keys</span>
    <span class="k">for</span> <span class="n">counter</span><span class="p">,</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">_keys</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
        <span class="c1"># set next_key value</span>
        <span class="k">if</span> <span class="n">counter</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">_keys</span><span class="p">):</span>
            <span class="n">next_key</span> <span class="o">=</span> <span class="n">_keys</span><span class="p">[</span><span class="n">counter</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">next_key</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># key is str, therefore _element is dict</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">_element</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="c1"># if key in the dictionary, access it</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">_element</span><span class="p">:</span>
                    <span class="n">_element</span> <span class="o">=</span> <span class="n">_element</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                <span class="c1"># else, create new item and access it</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">next_key</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                        <span class="n">_element</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">):</span> <span class="p">{}})</span>
                        <span class="n">_element</span> <span class="o">=</span> <span class="n">_element</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">next_key</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
                        <span class="n">_element</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">):</span> <span class="p">[]})</span>
                        <span class="n">_element</span> <span class="o">=</span> <span class="n">_element</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">next_key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">_element</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">):</span> <span class="p">{}})</span>
        <span class="c1"># key is int, therefore _element is list</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">_element</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="c1"># if list lenght is enought</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">_element</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">key</span><span class="p">:</span>
                    <span class="n">_dummy_element</span> <span class="o">=</span> <span class="n">_element</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                    <span class="c1"># create new item</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">next_key</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span>
                            <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">_dummy_element</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)):</span>
                        <span class="n">_element</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">next_key</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">and</span>
                            <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">_dummy_element</span><span class="p">,</span> <span class="nb">list</span><span class="p">)):</span>
                        <span class="n">_element</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="c1"># else, extend the list</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">_element</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">key</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">_element</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                    <span class="c1"># create new item</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">next_key</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                        <span class="n">_element</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">next_key</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
                        <span class="n">_element</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="c1"># access the item</span>
                <span class="n">_element</span> <span class="o">=</span> <span class="n">_element</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">dictionary</span></div>


<div class="viewcode-block" id="auxiliar_modify_params"><a class="viewcode-back" href="../../api.html#ctlearn_optimizer.common.auxiliar_modify_params">[docs]</a><span class="k">def</span> <span class="nf">auxiliar_modify_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hyperparams</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Modify the values of the hyperparameters in CTLearn configuration file.</span>

<span class="sd">    This function also modifies the logging model_directory of CTLearn and the</span>
<span class="sd">    prediction_file_path.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        self: ``ctlearn_optimizer.optimizer.Optimizer`` instance.</span>
<span class="sd">        hyperparams [dict]: dictionary containing values of the</span>
<span class="sd">            hyperparameters.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># load ctlearn config file</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ctlearn_config_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">config</span><span class="p">:</span>
        <span class="n">myconfig</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>

    <span class="c1"># empty layers list in myconfig in order to get rid of previous</span>
    <span class="c1"># configurations</span>
    <span class="n">myconfig</span><span class="p">[</span><span class="s1">&#39;Model&#39;</span><span class="p">][</span><span class="s1">&#39;Model Parameters&#39;</span><span class="p">][</span><span class="s1">&#39;basic&#39;</span><span class="p">][</span><span class="s1">&#39;conv_block&#39;</span><span class="p">][</span><span class="s1">&#39;layers&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># modify values of the hyperparameters in myconfig</span>
    <span class="k">for</span> <span class="n">param</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">hyperparams</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">param</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">hyperparameters_config</span><span class="p">:</span>
            <span class="c1"># create hyperparameter empty item in myconfig</span>
            <span class="n">create_nested_item</span><span class="p">(</span><span class="n">myconfig</span><span class="p">,</span> <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">hyperparameters_config</span><span class="p">[</span><span class="n">param</span><span class="p">])</span>
            <span class="c1"># set hyperparameter value</span>
            <span class="n">set_value</span><span class="p">(</span><span class="n">myconfig</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">hyperparameters_config</span><span class="p">[</span><span class="n">param</span><span class="p">])</span>

    <span class="c1"># set model_directory and prediction_file_path</span>
    <span class="n">myconfig</span><span class="p">[</span><span class="s1">&#39;Logging&#39;</span><span class="p">][</span><span class="s1">&#39;model_directory&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">working_directory</span><span class="p">,</span> <span class="s1">&#39;run&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">iteration</span><span class="o">.</span><span class="n">value</span><span class="p">))</span>
    <span class="n">myconfig</span><span class="p">[</span><span class="s1">&#39;Prediction&#39;</span><span class="p">][</span><span class="s1">&#39;prediction_file_path&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">working_directory</span><span class="p">,</span> <span class="s1">&#39;run&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">iteration</span><span class="o">.</span><span class="n">value</span><span class="p">),</span>
        <span class="s1">&#39;predictions_run</span><span class="si">{}</span><span class="s1">.csv&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">iteration</span><span class="o">.</span><span class="n">value</span><span class="p">))</span>

    <span class="c1"># dump ctlearn configuration</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ctlearn_config_path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">config</span><span class="p">:</span>
        <span class="n">yaml</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">myconfig</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span></div>


<div class="viewcode-block" id="get_pred_metrics"><a class="viewcode-back" href="../../api.html#ctlearn_optimizer.common.get_pred_metrics">[docs]</a><span class="k">def</span> <span class="nf">get_pred_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get CTLearn prediction metrics from the current CTLearn logging folder.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        self: ``ctlearn_optimizer.optimizer.Optimizer`` instance.</span>

<span class="sd">    Returns:</span>
<span class="sd">        metrics_pred_to_log [dict]:</span>
<span class="sd">            dictionary containing prediction set metrics to log to the</span>
<span class="sd">            optimization results file.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># load prediction file</span>
    <span class="n">predictions_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">working_directory</span><span class="p">,</span> <span class="s1">&#39;run&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">iteration</span><span class="o">.</span><span class="n">value</span><span class="p">),</span>
        <span class="s1">&#39;predictions_run</span><span class="si">{}</span><span class="s1">.csv&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">iteration</span><span class="o">.</span><span class="n">value</span><span class="p">))</span>

    <span class="c1"># load prediction data</span>
    <span class="n">predictions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">genfromtxt</span><span class="p">(</span><span class="n">predictions_path</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="n">predictions</span><span class="p">[</span><span class="s1">&#39;gamma_hadron_label&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">gamma_classifier_values</span> <span class="o">=</span> <span class="n">predictions</span><span class="p">[</span><span class="s1">&#39;gamma&#39;</span><span class="p">]</span>
    <span class="n">predicted_class</span> <span class="o">=</span> <span class="n">predictions</span><span class="p">[</span><span class="s1">&#39;predicted_class&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

    <span class="c1"># compute metrics</span>
    <span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">_thresholds</span> <span class="o">=</span> <span class="n">sklearn</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">roc_curve</span><span class="p">(</span>
        <span class="n">labels</span><span class="p">,</span> <span class="n">gamma_classifier_values</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">auc</span> <span class="o">=</span> <span class="n">sklearn</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">auc</span><span class="p">(</span><span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">)</span>
    <span class="n">f1</span> <span class="o">=</span> <span class="n">sklearn</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">f1_score</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">predicted_class</span><span class="p">)</span>
    <span class="n">acc</span> <span class="o">=</span> <span class="n">sklearn</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">accuracy_score</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">predicted_class</span><span class="p">)</span>
    <span class="n">bacc</span> <span class="o">=</span> <span class="n">sklearn</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">balanced_accuracy_score</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">predicted_class</span><span class="p">)</span>
    <span class="n">prec</span> <span class="o">=</span> <span class="n">sklearn</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">precision_score</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">predicted_class</span><span class="p">)</span>
    <span class="n">rec</span> <span class="o">=</span> <span class="n">sklearn</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">recall_score</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">predicted_class</span><span class="p">)</span>
    <span class="n">log_loss</span> <span class="o">=</span> <span class="n">sklearn</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">log_loss</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">predicted_class</span><span class="p">)</span>

    <span class="n">metrics_pred</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;auc&#39;</span><span class="p">:</span> <span class="n">auc</span><span class="p">,</span> <span class="s1">&#39;acc&#39;</span><span class="p">:</span> <span class="n">acc</span><span class="p">,</span> <span class="s1">&#39;bacc&#39;</span><span class="p">:</span> <span class="n">bacc</span><span class="p">,</span> <span class="s1">&#39;f1&#39;</span><span class="p">:</span> <span class="n">f1</span><span class="p">,</span>
                    <span class="s1">&#39;prec&#39;</span><span class="p">:</span> <span class="n">prec</span><span class="p">,</span> <span class="s1">&#39;rec&#39;</span><span class="p">:</span> <span class="n">rec</span><span class="p">,</span> <span class="s1">&#39;log_loss&#39;</span><span class="p">:</span> <span class="n">log_loss</span><span class="p">}</span>

    <span class="c1"># compute validation user defined metric if required</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_defined_metric_pred</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">user_defined</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user_defined_metric_pred</span><span class="p">[</span><span class="s1">&#39;expression&#39;</span><span class="p">])</span>
        <span class="n">metrics_pred</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
            <span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">user_defined_metric_pred</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]:</span> <span class="n">user_defined</span><span class="p">})</span>

    <span class="c1"># return metrics_pred_to_log</span>
    <span class="n">metrics_pred_to_log</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_metrics_pred_to_log</span><span class="p">:</span>
        <span class="n">metrics_pred_to_log</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
            <span class="p">{</span><span class="n">metric</span> <span class="o">+</span> <span class="s1">&#39;_pred&#39;</span><span class="p">:</span> <span class="n">metrics_pred</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">metric</span><span class="p">)})</span>

    <span class="k">return</span> <span class="n">metrics_pred_to_log</span></div>


<div class="viewcode-block" id="get_val_metrics"><a class="viewcode-back" href="../../api.html#ctlearn_optimizer.common.get_val_metrics">[docs]</a><span class="k">def</span> <span class="nf">get_val_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get CTLearn validation metrics from the current CTLearn logging folder.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        self: ``ctlearn_optimizer.optimizer.Optimizer`` instance.</span>

<span class="sd">    Returns:</span>
<span class="sd">        metrics_val_to_log [dict]:</span>
<span class="sd">            dictionary containing validation set metrics to log to the</span>
<span class="sd">            optimization results file.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># load training log file</span>
    <span class="n">run_folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">working_directory</span><span class="p">,</span>
                              <span class="s1">&#39;run&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">iteration</span><span class="o">.</span><span class="n">value</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">run_folder</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;logfile.log&#39;</span><span class="p">):</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">run_folder</span><span class="p">,</span> <span class="n">file</span><span class="p">))</span> <span class="k">as</span> <span class="n">log_file</span><span class="p">:</span>
                <span class="n">contents</span> <span class="o">=</span> <span class="n">log_file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                <span class="c1"># ensure that prediction log file is not loaded</span>
                <span class="k">if</span> <span class="s1">&#39;Training&#39;</span> <span class="ow">in</span> <span class="n">contents</span><span class="p">:</span>
                    <span class="n">train_logfile</span> <span class="o">=</span> <span class="n">file</span>

    <span class="c1"># find required data</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">run_folder</span><span class="p">,</span> <span class="n">train_logfile</span><span class="p">),</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">stream</span><span class="p">:</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">&#39;INFO:Saving dict for global step .*&#39;</span><span class="p">)</span>
        <span class="n">matches</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">match</span><span class="p">,</span> <span class="n">stream</span><span class="p">))</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">matches</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="n">val_info</span> <span class="o">=</span> <span class="n">matches</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="c1"># extract validation metrics</span>
    <span class="n">auc</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;auc = [-+]?\d*\.*\d+&#39;</span><span class="p">,</span> <span class="n">val_info</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">6</span><span class="p">:])</span>
    <span class="n">acc</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;accuracy = [-+]?\d*\.*\d+&#39;</span><span class="p">,</span> <span class="n">val_info</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">11</span><span class="p">:])</span>
    <span class="n">acc_gamma</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span>
        <span class="sa">r</span><span class="s1">&#39;accuracy_gamma = [-+]?\d*\.*\d+&#39;</span><span class="p">,</span> <span class="n">val_info</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">17</span><span class="p">:])</span>
    <span class="n">acc_proton</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span>
        <span class="sa">r</span><span class="s1">&#39;accuracy_proton = [-+]?\d*\.*\d+&#39;</span><span class="p">,</span> <span class="n">val_info</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">18</span><span class="p">:])</span>
    <span class="n">loss</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;loss = [-+]?\d*\.*\d+&#39;</span><span class="p">,</span> <span class="n">val_info</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">7</span><span class="p">:])</span>

    <span class="n">metrics_val</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;auc&#39;</span><span class="p">:</span> <span class="n">auc</span><span class="p">,</span> <span class="s1">&#39;acc&#39;</span><span class="p">:</span> <span class="n">acc</span><span class="p">,</span> <span class="s1">&#39;acc_gamma&#39;</span><span class="p">:</span> <span class="n">acc_gamma</span><span class="p">,</span>
                   <span class="s1">&#39;acc_proton&#39;</span><span class="p">:</span> <span class="n">acc_proton</span><span class="p">,</span> <span class="s1">&#39;loss&#39;</span><span class="p">:</span> <span class="n">loss</span><span class="p">}</span>

    <span class="c1"># compute prediction user defined metric</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_defined_metric_val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">user_defined</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">user_defined_metric_val</span><span class="p">[</span><span class="s1">&#39;expression&#39;</span><span class="p">],</span> <span class="n">metrics_val</span><span class="p">)</span>
        <span class="n">metrics_val</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
            <span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">user_defined_metric_val</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]:</span> <span class="n">user_defined</span><span class="p">})</span>

    <span class="c1"># return metrics_val_to_log</span>
    <span class="n">metrics_val_to_log</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_metrics_val_to_log</span><span class="p">:</span>
        <span class="n">metrics_val_to_log</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">metric</span> <span class="o">+</span> <span class="s1">&#39;_val&#39;</span><span class="p">:</span> <span class="n">metrics_val</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">metric</span><span class="p">)})</span>

    <span class="k">return</span> <span class="n">metrics_val_to_log</span></div>


<div class="viewcode-block" id="set_basic_config"><a class="viewcode-back" href="../../api.html#ctlearn_optimizer.common.set_basic_config">[docs]</a><span class="k">def</span> <span class="nf">set_basic_config</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Set basic config and fixed hyperparameters in CTLearn config file.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        self: ``ctlearn_optimizer.optimizer.Optimizer`` instance.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># load ctlearn config file</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ctlearn_config_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">config</span><span class="p">:</span>
        <span class="n">myconfig</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>

    <span class="c1"># set basic configuration</span>
    <span class="n">myconfig</span><span class="p">[</span><span class="s1">&#39;Training&#39;</span><span class="p">][</span><span class="s1">&#39;num_validations&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basic_config</span>
                                               <span class="p">[</span><span class="s1">&#39;num_validations&#39;</span><span class="p">])</span>
    <span class="n">myconfig</span><span class="p">[</span><span class="s1">&#39;Training&#39;</span><span class="p">][</span><span class="s1">&#39;num_training_steps_per_validation&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">basic_config</span><span class="p">[</span><span class="s1">&#39;num_training_steps_per_validation&#39;</span><span class="p">])</span>
    <span class="n">myconfig</span><span class="p">[</span><span class="s1">&#39;Data&#39;</span><span class="p">][</span><span class="s1">&#39;Input&#39;</span><span class="p">][</span><span class="s1">&#39;batch_size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">basic_config</span><span class="p">[</span><span class="s1">&#39;batch_size&#39;</span><span class="p">]</span>
    <span class="n">myconfig</span><span class="p">[</span><span class="s1">&#39;Model&#39;</span><span class="p">][</span><span class="s1">&#39;model_directory&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">basic_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
        <span class="s1">&#39;model_directory&#39;</span><span class="p">,</span> <span class="s1">&#39;null&#39;</span><span class="p">)</span>
    <span class="n">myconfig</span><span class="p">[</span><span class="s1">&#39;Data&#39;</span><span class="p">][</span><span class="s1">&#39;Loading&#39;</span><span class="p">][</span><span class="s1">&#39;validation_split&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basic_config</span>
                                                       <span class="p">[</span><span class="s1">&#39;validation_split&#39;</span><span class="p">])</span>
    <span class="n">myconfig</span><span class="p">[</span><span class="s1">&#39;Data&#39;</span><span class="p">][</span><span class="s1">&#39;Processing&#39;</span><span class="p">][</span><span class="s1">&#39;sorting&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">basic_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
        <span class="s1">&#39;sorting&#39;</span><span class="p">,</span> <span class="s1">&#39;null&#39;</span><span class="p">)</span>
    <span class="n">myconfig</span><span class="p">[</span><span class="s1">&#39;Data&#39;</span><span class="p">][</span><span class="s1">&#39;Loading&#39;</span><span class="p">][</span><span class="s1">&#39;min_num_tels&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">basic_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
        <span class="s1">&#39;min_num_tels&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">myconfig</span><span class="p">[</span><span class="s1">&#39;Data&#39;</span><span class="p">][</span><span class="s1">&#39;Loading&#39;</span><span class="p">][</span><span class="s1">&#39;example_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basic_config</span>
                                                   <span class="p">[</span><span class="s1">&#39;example_type&#39;</span><span class="p">])</span>
    <span class="n">myconfig</span><span class="p">[</span><span class="s1">&#39;Data&#39;</span><span class="p">][</span><span class="s1">&#39;Loading&#39;</span><span class="p">][</span><span class="s1">&#39;seed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">basic_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;seed&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">basic_config</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;cnn_rnn&#39;</span><span class="p">:</span>
        <span class="n">myconfig</span><span class="p">[</span><span class="s1">&#39;Model&#39;</span><span class="p">][</span><span class="s1">&#39;model&#39;</span><span class="p">][</span><span class="s1">&#39;module&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;cnn_rnn&#39;</span>
        <span class="n">myconfig</span><span class="p">[</span><span class="s1">&#39;Model&#39;</span><span class="p">][</span><span class="s1">&#39;model&#39;</span><span class="p">][</span><span class="s1">&#39;function&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;cnn_rnn_model&#39;</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">basic_config</span><span class="p">[</span><span class="s1">&#39;example_type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;array&#39;</span>

    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">basic_config</span><span class="p">[</span><span class="s1">&#39;example_type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;single_tel&#39;</span><span class="p">:</span>
        <span class="n">myconfig</span><span class="p">[</span><span class="s1">&#39;Model&#39;</span><span class="p">][</span><span class="s1">&#39;model&#39;</span><span class="p">][</span><span class="s1">&#39;module&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;single_tel&#39;</span>
        <span class="n">myconfig</span><span class="p">[</span><span class="s1">&#39;Model&#39;</span><span class="p">][</span><span class="s1">&#39;model&#39;</span><span class="p">][</span><span class="s1">&#39;function&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;single_tel_model&#39;</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">basic_config</span><span class="p">[</span><span class="s1">&#39;example_type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;single_tel&#39;</span>

    <span class="n">myconfig</span><span class="p">[</span><span class="s1">&#39;Data&#39;</span><span class="p">][</span><span class="s1">&#39;Loading&#39;</span><span class="p">][</span><span class="s1">&#39;selected_tel_types&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">basic_config</span><span class="p">[</span><span class="s1">&#39;selected_tel_types&#39;</span><span class="p">])</span>

    <span class="n">aux_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;SST:ASTRICam&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;camera_types&#39;</span><span class="p">:</span> <span class="s1">&#39;ASTRICam&#39;</span><span class="p">,</span>
                                 <span class="s1">&#39;interpolation_image_shape&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">56</span><span class="p">,</span> <span class="mi">56</span><span class="p">,</span> <span class="mi">1</span><span class="p">]},</span>
                <span class="s1">&#39;SST:CHEC&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;camera_types&#39;</span><span class="p">:</span> <span class="s1">&#39;CHEC&#39;</span><span class="p">,</span>
                             <span class="s1">&#39;interpolation_image_shape&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">48</span><span class="p">,</span> <span class="mi">48</span><span class="p">,</span> <span class="mi">1</span><span class="p">]},</span>
                <span class="s1">&#39;SST:DigiCam&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;camera_types&#39;</span><span class="p">:</span> <span class="s1">&#39;DigiCam&#39;</span><span class="p">,</span>
                                <span class="s1">&#39;interpolation_image_shape&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">96</span><span class="p">,</span> <span class="mi">96</span><span class="p">,</span> <span class="mi">1</span><span class="p">]},</span>
                <span class="s1">&#39;MST:FlashCam&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;camera_types&#39;</span><span class="p">:</span> <span class="s1">&#39;FlashCam&#39;</span><span class="p">,</span>
                                 <span class="s1">&#39;interpolation_image_shape&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">112</span><span class="p">,</span> <span class="mi">112</span><span class="p">,</span> <span class="mi">1</span><span class="p">]},</span>
                <span class="s1">&#39;LST:LSTCam&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;camera_types&#39;</span><span class="p">:</span> <span class="s1">&#39;LSTCam&#39;</span><span class="p">,</span>
                               <span class="s1">&#39;interpolation_image_shape&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">110</span><span class="p">,</span> <span class="mi">110</span><span class="p">,</span> <span class="mi">1</span><span class="p">]},</span>
                <span class="s1">&#39;MST:NectarCam&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;camera_types&#39;</span><span class="p">:</span> <span class="s1">&#39;NectarCam&#39;</span><span class="p">,</span>
                                  <span class="s1">&#39;interpolation_image_shape&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">110</span><span class="p">,</span> <span class="mi">110</span><span class="p">,</span> <span class="mi">1</span><span class="p">]},</span>
                <span class="s1">&#39;SCT:SCTCam&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;camera_types&#39;</span><span class="p">:</span> <span class="s1">&#39;SCTCam&#39;</span><span class="p">,</span>
                               <span class="s1">&#39;interpolation_image_shape&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">120</span><span class="p">,</span> <span class="mi">120</span><span class="p">,</span> <span class="mi">1</span><span class="p">]}}</span>

    <span class="n">myconfig</span><span class="p">[</span><span class="s1">&#39;Image Mapping&#39;</span><span class="p">][</span><span class="s1">&#39;camera_types&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">myconfig</span><span class="p">[</span><span class="s1">&#39;Image Mapping&#39;</span><span class="p">][</span><span class="s1">&#39;interpolation_image_shape&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">tel_type</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">basic_config</span><span class="p">[</span><span class="s1">&#39;selected_tel_types&#39;</span><span class="p">]:</span>
        <span class="n">element</span> <span class="o">=</span> <span class="n">aux_dict</span><span class="p">[</span><span class="n">tel_type</span><span class="p">]</span>
        <span class="n">myconfig</span><span class="p">[</span><span class="s1">&#39;Image Mapping&#39;</span><span class="p">][</span><span class="s1">&#39;camera_types&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">element</span><span class="p">[</span><span class="s1">&#39;camera_types&#39;</span><span class="p">])</span>
        <span class="n">myconfig</span><span class="p">[</span><span class="s1">&#39;Image Mapping&#39;</span><span class="p">][</span><span class="s1">&#39;interpolation_image_shape&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
            <span class="p">{</span><span class="n">element</span><span class="p">[</span><span class="s1">&#39;camera_types&#39;</span><span class="p">]:</span> <span class="n">element</span><span class="p">[</span><span class="s1">&#39;interpolation_image_shape&#39;</span><span class="p">]})</span>

    <span class="c1"># set values of the fixed hyperparameters</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fixed_hyperparameters</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">param</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fixed_hyperparameters</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">create_nested_item</span><span class="p">(</span><span class="n">myconfig</span><span class="p">,</span> <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">hyperparameters_config</span><span class="p">[</span><span class="n">param</span><span class="p">])</span>
            <span class="n">set_value</span><span class="p">(</span><span class="n">myconfig</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">hyperparameters_config</span><span class="p">[</span><span class="n">param</span><span class="p">])</span>

    <span class="c1"># dump ctlearn configuration</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ctlearn_config_path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">config</span><span class="p">:</span>
        <span class="n">yaml</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">myconfig</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span></div>


<div class="viewcode-block" id="train"><a class="viewcode-back" href="../../api.html#ctlearn_optimizer.common.train">[docs]</a><span class="k">def</span> <span class="nf">train</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Run a CTlearn model training.</span>

<span class="sd">    Debug is set to False and log_to_file is set to True.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        self: ``ctlearn_optimizer.optimizer.Optimizer`` instance.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># update file_list in ctlearn config</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ctlearn_config_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">config</span><span class="p">:</span>
        <span class="n">myconfig</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>

    <span class="n">myconfig</span><span class="p">[</span><span class="s1">&#39;Data&#39;</span><span class="p">][</span><span class="s1">&#39;file_list&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">working_directory</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">basic_config</span><span class="p">[</span><span class="s1">&#39;training_file_list&#39;</span><span class="p">])</span>

    <span class="c1"># dump ctlearn configuration</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ctlearn_config_path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">config</span><span class="p">:</span>
        <span class="n">yaml</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">myconfig</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>

    <span class="c1"># run training</span>
    <span class="n">run_model</span><span class="p">(</span><span class="n">myconfig</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;train&#39;</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">log_to_file</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>


<div class="viewcode-block" id="predict"><a class="viewcode-back" href="../../api.html#ctlearn_optimizer.common.predict">[docs]</a><span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Predict using a trained CTLearn model.</span>

<span class="sd">    Debug is set to False and log_to_file is set to True.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        self: ``ctlearn_optimizer.optimizer.Optimizer`` instance.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># update file_list in ctlearn config</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ctlearn_config_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">config</span><span class="p">:</span>
        <span class="n">myconfig</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>

    <span class="n">myconfig</span><span class="p">[</span><span class="s1">&#39;Data&#39;</span><span class="p">][</span><span class="s1">&#39;file_list&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">working_directory</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">basic_config</span><span class="p">[</span><span class="s1">&#39;prediction_file_list&#39;</span><span class="p">])</span>

    <span class="c1"># modify ctlearn config to make sure that a prediction file will be created</span>
    <span class="n">myconfig</span><span class="p">[</span><span class="s1">&#39;Prediction&#39;</span><span class="p">][</span><span class="s1">&#39;export_as_file&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">myconfig</span><span class="p">[</span><span class="s1">&#39;Prediction&#39;</span><span class="p">][</span><span class="s1">&#39;true_labels_given&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="c1"># dump ctlearn configuration</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ctlearn_config_path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">config</span><span class="p">:</span>
        <span class="n">yaml</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">myconfig</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>

    <span class="c1"># run prediction</span>
    <span class="n">run_model</span><span class="p">(</span><span class="n">myconfig</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;predict&#39;</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">log_to_file</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>


<div class="viewcode-block" id="modify_optimizable_params"><a class="viewcode-back" href="../../api.html#ctlearn_optimizer.common.modify_optimizable_params">[docs]</a><span class="k">def</span> <span class="nf">modify_optimizable_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hyperparams</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Update CTLearn config file with new hyperparameters at each iteration.</span>

<span class="sd">    This function takes the dictionary containing the values of the</span>
<span class="sd">    hyperparameters to optimize suggested by the optimizer, flattens and</span>
<span class="sd">    corrects the dictionary if required, then add the values of the dependent</span>
<span class="sd">    hyperparameters to the dictionary. Finally calls</span>
<span class="sd">    ``auxiliar_modify_params()`` to modify the hyperparameters.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        self: ``ctlearn_optimizer.optimizer.Optimizer`` instance.</span>
<span class="sd">        hyperparams [dict]: flat or nested dictionary containing the values of</span>
<span class="sd">            the hyperparameters to optimize suggested by the optimizer.</span>

<span class="sd">    Returns:</span>
<span class="sd">        flat dictionary containing the values of the dependent hyperparameters</span>
<span class="sd">        and hyperparameters to optimize  [dict].</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># flatten optimizable hyperparameters dict if required</span>
    <span class="k">def</span> <span class="nf">aux_flat</span><span class="p">(</span><span class="n">hyperparams</span><span class="p">):</span>
        <span class="n">flat_hyperparams</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">hyperparams</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="n">flat_hyperparams</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">key</span><span class="p">:</span> <span class="n">item</span><span class="p">})</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">flat_hyperparams</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">aux_flat</span><span class="p">(</span><span class="n">item</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">flat_hyperparams</span>

    <span class="n">hyperparams</span> <span class="o">=</span> <span class="n">aux_flat</span><span class="p">(</span><span class="n">hyperparams</span><span class="p">)</span>

    <span class="c1"># correct hyperparameters_to_optimize keys (hyperopt space creator doesn&#39;t</span>
    <span class="c1"># support repeated labels, so a ! character is appended to each repeated</span>
    <span class="c1"># label)</span>
    <span class="n">corrected_hyperparams</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">hyperparams</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;!&#39;</span><span class="p">):</span>
            <span class="n">dummy_key</span> <span class="o">=</span> <span class="n">key</span>
            <span class="k">while</span> <span class="n">dummy_key</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;!&#39;</span><span class="p">):</span>
                <span class="n">dummy_key</span> <span class="o">=</span> <span class="n">dummy_key</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">corrected_hyperparams</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">dummy_key</span><span class="p">:</span> <span class="n">hyperparams</span><span class="p">[</span><span class="n">key</span><span class="p">]})</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">corrected_hyperparams</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">key</span><span class="p">:</span> <span class="n">hyperparams</span><span class="p">[</span><span class="n">key</span><span class="p">]})</span>

    <span class="n">hyperparams</span> <span class="o">=</span> <span class="n">corrected_hyperparams</span>

    <span class="c1"># add dependent hyperparameters to the hyperparameters dict</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dependent_hyperparameters</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">param</span><span class="p">,</span> <span class="n">expression</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dependent_hyperparameters</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">hyperparams</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">param</span><span class="p">:</span> <span class="nb">eval</span><span class="p">(</span><span class="n">expression</span><span class="p">,</span> <span class="n">hyperparams</span><span class="p">)})</span>

    <span class="c1"># update myconfig with the values in hyperparams dict</span>
    <span class="n">auxiliar_modify_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hyperparams</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">hyperparams</span></div>


<div class="viewcode-block" id="save"><a class="viewcode-back" href="../../api.html#ctlearn_optimizer.common.save">[docs]</a><span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Save trials of the current run at the working folder as ``trials.pkl``.</span>

<span class="sd">    Currently, trial saving for only tree_parzen_estimators, random_search or</span>
<span class="sd">    gaussian_processes based optimization using Ray Tune is supported.</span>

<span class="sd">    Raises:</span>
<span class="sd">        NotImplementedError: if self.optimization_type == &#39;genetic_algorithm&#39;.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">optimization_type</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;tree_parzen_estimators&#39;</span><span class="p">,</span>
                                  <span class="s1">&#39;random_search&#39;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">optimization_algorithm</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trials_file_path</span><span class="p">)</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">optimization_type</span> <span class="o">==</span> <span class="s1">&#39;gaussian_processes&#39;</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trials_file_path</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">output_file</span><span class="p">:</span>
            <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gp_opt</span><span class="p">,</span> <span class="n">output_file</span><span class="p">)</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">optimization_type</span> <span class="o">==</span> <span class="s1">&#39;genetic_algorithm&#39;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;trial saving is not currently </span><span class="se">\</span>
<span class="s1">            supported by the genetic algorithm optimization&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="restore"><a class="viewcode-back" href="../../api.html#ctlearn_optimizer.common.restore">[docs]</a><span class="k">def</span> <span class="nf">restore</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Load ``trials.pkl`` of a previous run from the ``working_directory``.</span>

<span class="sd">    Currently, trial loading for only tree_parzen_estimators, random_search or</span>
<span class="sd">    gaussian_processes based optimization using Ray Tune is supported.</span>

<span class="sd">    Returns:</span>
<span class="sd">        gp_opt_restored [skopt.optimizer.optimizer.Optimizer]:</span>
<span class="sd">            optimizer provided from Skopt (only if self.optimization.type ==</span>
<span class="sd">            &#39;gaussian_processes&#39;).</span>


<span class="sd">    Raises:</span>
<span class="sd">        NotImplementedError: if self.optimization_type is genetic_algorithm.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">optimization_type</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;tree_parzen_estimators&#39;</span><span class="p">,</span>
                                  <span class="s1">&#39;random_search&#39;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">optimization_algorithm</span><span class="o">.</span><span class="n">restore</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trials_file_path</span><span class="p">)</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">optimization_type</span> <span class="o">==</span> <span class="s1">&#39;gaussian_processes&#39;</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trials_file_path</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">input_file</span><span class="p">:</span>
            <span class="n">gp_opt_restored</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">input_file</span><span class="p">)</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">optimization_type</span> <span class="o">==</span> <span class="s1">&#39;genetic_algorithm&#39;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;trial loading is not currently </span><span class="se">\</span>
<span class="s1">                     supported by the genetic algorithm optimization&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">gp_opt_restored</span> <span class="k">if</span> <span class="s1">&#39;gp_opt_restored&#39;</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">()</span> <span class="k">else</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="set_logger"><a class="viewcode-back" href="../../api.html#ctlearn_optimizer.common.set_logger">[docs]</a><span class="k">def</span> <span class="nf">set_logger</span><span class="p">(</span><span class="n">log_path</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Set up new logger writing to both log_path and stdout.</span>

<span class="sd">    Ray Tune optimizator runs the objective function on a different Python</span>
<span class="sd">    process, so new loggers writing to the same file have to be created when</span>
<span class="sd">    necessary.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        log_path [str]: path to log file.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">()</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
    <span class="n">formatter</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">Formatter</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%(levelname)s</span><span class="s2">:</span><span class="si">%(message)s</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="c1"># log to file</span>
    <span class="n">file_handler</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">FileHandler</span><span class="p">(</span><span class="n">log_path</span><span class="p">)</span>
    <span class="n">file_handler</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">formatter</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">file_handler</span><span class="p">)</span>
    <span class="c1"># log to stdout</span>
    <span class="n">console_handler</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">StreamHandler</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>
    <span class="n">console_handler</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">formatter</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">console_handler</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">logger</span></div>


<div class="viewcode-block" id="optimization_results_logger"><a class="viewcode-back" href="../../api.html#ctlearn_optimizer.common.optimization_results_logger">[docs]</a><span class="k">def</span> <span class="nf">optimization_results_logger</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">loss</span><span class="p">,</span> <span class="n">hyperparams_dict</span><span class="p">,</span> <span class="n">metrics_pred</span><span class="p">,</span>
                                <span class="n">metrics_val</span><span class="p">,</span> <span class="n">run_time</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Write loss, hyperparameters, metrics and run_time to the results file.</span>

<span class="sd">    This function log the data to the optimization_results file stored as</span>
<span class="sd">    ``optimization_results.csv`` at ``working_directory``.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        self: ``ctlearn_optimizer.optimizer.Optimizer`` instance.</span>
<span class="sd">        loss [float]: value to optimize.</span>
<span class="sd">        hyperparams_dict [dict]: values of the hyperparameters the user wishes</span>
<span class="sd">            to store.</span>
<span class="sd">        metrics_pred [dict]: values of the prediction set metrics the user</span>
<span class="sd">            wishes to store.</span>
<span class="sd">        metrics_val [dict]: values of the validation set metrics the user</span>
<span class="sd">            wishes to store.</span>
<span class="sd">        run_time [float]: execution time the user wishes to store.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">optim_results_path</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
        <span class="n">writer</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">writer</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
        <span class="n">row_hyperparams</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">hyperparams_to_log</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">hyperparams_dict</span><span class="p">:</span>
                <span class="n">row_hyperparams</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hyperparams_dict</span><span class="p">[</span><span class="n">element</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">row_hyperparams</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">row</span> <span class="o">=</span> <span class="p">[</span><span class="n">loss</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">iteration</span><span class="o">.</span><span class="n">value</span><span class="p">]</span> <span class="o">+</span> <span class="n">row_hyperparams</span> <span class="o">+</span> \
            <span class="nb">list</span><span class="p">(</span><span class="n">metrics_val</span><span class="o">.</span><span class="n">values</span><span class="p">())</span> <span class="o">+</span> \
            <span class="nb">list</span><span class="p">(</span><span class="n">metrics_pred</span><span class="o">.</span><span class="n">values</span><span class="p">())</span> <span class="o">+</span> <span class="p">[</span><span class="n">run_time</span><span class="p">]</span>
        <span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">(</span><span class="n">row</span><span class="p">)</span></div>


<div class="viewcode-block" id="ctlearn_objective"><a class="viewcode-back" href="../../api.html#ctlearn_optimizer.common.ctlearn_objective">[docs]</a><span class="k">def</span> <span class="nf">ctlearn_objective</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hyperparams</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Evaluate a CTLearn model and return metric to optimize.</span>

<span class="sd">    Train a CTLearn model and predict if necessary, get the metrics and log</span>
<span class="sd">    them to the optimization_results file. Also save trials file for resuming</span>
<span class="sd">    training if it has been interrupted.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        self: ``ctlearn_optimizer.optimizer.Optimizer`` instance.</span>
<span class="sd">        hyperparams [dict]: values of the hyperparameters to evaluate</span>
<span class="sd">            suggested by the optimizer.</span>

<span class="sd">    Returns:</span>
<span class="sd">        loss [float]: metric to optimize.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># set up logger</span>
    <span class="n">logger</span> <span class="o">=</span> <span class="n">set_logger</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log_path</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">iteration</span><span class="o">.</span><span class="n">value</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">counter</span><span class="o">.</span><span class="n">value</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Current run iteration: </span><span class="si">{}</span><span class="s1">&#39;</span> <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">counter</span><span class="o">.</span><span class="n">value</span><span class="p">))</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Global iteration: </span><span class="si">{}</span><span class="s1">&#39;</span> <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">iteration</span><span class="o">.</span><span class="n">value</span><span class="p">))</span>

    <span class="c1"># update values of the hyperparameters</span>
    <span class="n">hyperparams_dict</span> <span class="o">=</span> <span class="n">modify_optimizable_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hyperparams</span><span class="p">)</span>

    <span class="n">start</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Training&#39;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Current hyperparameters: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span> <span class="nb">format</span><span class="p">(</span><span class="n">hyperparams_dict</span><span class="p">))</span>

    <span class="c1"># train ctlearn network</span>
    <span class="n">train</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
    <span class="n">logger</span> <span class="o">=</span> <span class="n">set_logger</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log_path</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Training ended&#39;</span><span class="p">)</span>
    <span class="n">run_time</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span>

    <span class="c1"># get validation set metrics</span>
    <span class="n">metrics_val</span> <span class="o">=</span> <span class="n">get_val_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
    <span class="n">metrics_pred</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># predict if required</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_set_to_optimize</span> <span class="o">==</span> <span class="s1">&#39;prediction&#39;</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Predicting&#39;</span><span class="p">)</span>
        <span class="n">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">logger</span> <span class="o">=</span> <span class="n">set_logger</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log_path</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Prediction ended&#39;</span><span class="p">)</span>
        <span class="n">metrics_pred</span> <span class="o">=</span> <span class="n">get_pred_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="c1"># set loss depending on metric and data set to optimize</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_set_to_optimize</span> <span class="o">==</span> <span class="s1">&#39;validation&#39;</span><span class="p">:</span>
        <span class="n">metric</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metric_to_optimize</span> <span class="o">+</span> <span class="s1">&#39;_val&#39;</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="n">metrics_val</span><span class="p">[</span><span class="n">metric</span><span class="p">]</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">: </span><span class="si">{:.4f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">metric</span><span class="p">,</span> <span class="n">metrics_val</span><span class="p">[</span><span class="n">metric</span><span class="p">]))</span>

    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_set_to_optimize</span> <span class="o">==</span> <span class="s1">&#39;prediction&#39;</span><span class="p">:</span>
        <span class="n">metric</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metric_to_optimize</span> <span class="o">+</span> <span class="s1">&#39;_pred&#39;</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="n">metrics_pred</span><span class="p">[</span><span class="n">metric</span><span class="p">]</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">: </span><span class="si">{:.4f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">metric</span><span class="p">,</span> <span class="n">metrics_pred</span><span class="p">[</span><span class="n">metric</span><span class="p">]))</span>

    <span class="c1"># write loss, hyperparameters, metrics and run_time to the optimization</span>
    <span class="c1"># results file</span>
    <span class="n">optimization_results_logger</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">loss</span><span class="p">,</span> <span class="n">hyperparams_dict</span><span class="p">,</span> <span class="n">metrics_pred</span><span class="p">,</span>
                                <span class="n">metrics_val</span><span class="p">,</span> <span class="n">run_time</span><span class="p">)</span>

    <span class="c1"># remove training folders in order to avoid space issues in long runs</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">remove_training_folders</span><span class="p">:</span>
        <span class="n">run_folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">working_directory</span><span class="p">,</span> <span class="s1">&#39;run&#39;</span> <span class="o">+</span>
                                  <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">iteration</span><span class="o">.</span><span class="n">value</span><span class="p">))</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">run_folder</span><span class="p">,</span> <span class="n">ignore_errors</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># save trials file</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">optimization_type</span> <span class="o">!=</span> <span class="s1">&#39;genetic_algorithm&#39;</span><span class="p">:</span>
        <span class="n">save</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">loss</span></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, Juan Alfonso Redondo Pizarro

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>